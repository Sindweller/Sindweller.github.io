---
layout: default
title: 2023/06/28 Mysql的几种日志以及各自用途
author: sindweller <sindweller5530@gmail.com>
tags: [存储]
---

## Binlog

binlog 顾名思义 二进制的日志

- 包含所有对数据库表/数据进行修改的操作
- 不包括select show等查询操作
- 是主从复制时的从库重现依据
  
### binlog的存储管理

当binlog不断追加，文件大小变的很大，是由mysql和操作系统（用户手动操作）两方面进行管理的

- mysql会根据两个参数来控制binlog的大小，以及所有binlog文件的数量
  - max_binlog_size 指定每个文件最大大小，如果达到了这个size，就会创建新的binlog文件
  - max_binlog_files 指定binlog文件的数量，如果达到了这个数量，就会删除最旧的文件
- mysql没有管理binlog文件的保存期限，可以用文件管理工具或者脚本定期清理旧的文件
  
### binlog的格式

binlog的格式就是上述修改以什么样的形式存储，主要是考虑到对主从复制的影响，因为主这边的修改操作在记录binlog之后，从节点重现不一定能重现出同样的结果。

- STATEMENT 默认 记录每条sql，可以理解为逻辑操作，主从复制的问题在于从无法正确重现一些动态函数，如uuid(), now()等，binlog就是这么记录下来的，但是从在使用这些动态函数时肯定得到的结果跟主不一样了
- ROW 记录行数据的最终状态，这个可以避免动态函数带来的问题，但是又引入了新的问题，假设批量updates数据，那么按照STATEMENT只用记录这一条批量updates语句就可以了，但是ROW会挨条记录行数据的最终状态，假如这批有100个，就100条语句，会导致binlog文件过大（binlog是追加，会变得很大，达到一定大小或时间后mysql会关闭当前文件新建一个，就是上面存储管理的部分所说的）【5.7.7之后的默认就是ROW】
- MIXED 就是STATEMENT+ROW 根据不同情况选择使用

### binlog的结构

日志是一组二进制日志文件binlog+1个索引文件index（保存binlog文件列表）

binlog的日志文件如下

```shell
+--------------------------+
|        File Header        |
+--------------------------+
|        Event Header       |
+--------------------------+
|      Event Descriptor     |
+--------------------------+
|        Event Data         |
+--------------------------+
|      Event Descriptor     |
+--------------------------+
|        Event Data         |
+--------------------------+
|            ...           |
+--------------------------+
```

头部一般保存一些元数据

#### 文件头
- 4字节的魔法数字，binlog magic number，它的值对应的ASCII码为254 98 105 110，用来标识二进制日志文件的格式和检查有效性。
  - 如何检验？可以使用 `hexdump -C -n 4 mysql-bin.000001` 命令，mysql会检验前4个字节，如果正确则会输出|.bin| 不正确则会输出|....| 举例如下：
    ```shell
    # 识别为binlog
    00000000  fe 62 69 6e                                    |.bin|
    00000004
    ```

    ```shell
    # 无法识别
    00000000  00 00 00 00                                    |....|
    00000004
    ```
- 2字节的文件版本，目前支持3 4 5，每个版本的不同在于支持数据操作类型和新的编码方式
- 字符串-服务器版本，标识mysql版本和操作系统类型
- 4字节的创建时间戳
- 事件头长度
- 事件头校验
- 文件尾（EOF）
  
#### 事件头

提供event的创建时间戳、服务器ID、事件类型、事件长度

#### 事件数据

具体数据修改，涉及事件类型：

- Query事件 记录事务，SQL语句执行情况，statement模式下增删改语句会生成该事件，row模式下ddl（增删改）会生成
- TableMap事件 记录表结构映射关系，包含表ID 名称 列数 列类型等信息，及每个列在行数据中的offset和长度
- ROWS_EVENT： Write_rows Update_rows Delete_rows事件 记录行数据修改情况
- ROTATE_EVENT 该开启下一个binlog了，指定下一个日志的名称和未知

### binlog的用途

1. mysql主从复制
2. mysql数据恢复
3. 基于binlog做与其他存储中间件的数据同步，例如es增量索引、kafka可靠消息、redis更新缓存

### binlog和redolog的区别？