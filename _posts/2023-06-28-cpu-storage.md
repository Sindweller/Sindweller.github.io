---
layout: default
title: 2023/06/28 CPU存储
author: sindweller <sindweller5530@gmail.com>
tags: [操作系统]
---

# 缓存与内存

缓存比内存快，是因为内存的存储是用的DRAM单元，动态随机存储器，需要电容充放电来实现数据存储，这是很慢的。

> 所谓动态，指的是需要周期性充电才能维持数据稳定，因为电容会“漏电”，电压变小之后就无法区分表达的是1还是0了。

缓存不需要充电，用的SRAM电路，是静态随机存储器，存储利用的是晶体管的导通与断开，速度很快。

这两个DRAM和SRAM单元都可以存储1比特的信息。但是缓存1单元要花费很多晶体管，而内存1单元只需要1个晶体管。

所以缓存也就是MB KB级别的，内存可以做到几十GB的容量。

# 内存如何存储数据

首先，内存存了什么数据？CPU工作需要指令、数据都存在内存里。

内存条里面有很多核心存储芯片，总共空间有16 * 1GB=16GB。连接内存和主板的插槽接触点被称为金手指。除此之外，还有PCB电路板。

存储芯片+PCB电路板+金手指=内存条。

内存条的另一个名称为RAM，随机存储器，因为可以随意读写上面任意位置的数据。寻找比特位需要告知内存芯片号、bank号、行地址、列地址。这些细节封装好了作为一个接口对外提供服务，由内存控制器完成。

内存控制器有两个主要的任务：

1. 定期刷新电容，最多64ms就要刷新一次
2. 寻址，用比特位作为读写单位太麻烦了，所以将比特位8个一组，分为1字节，CPU按照字节位单位统一给这些存储空间编址，将地址交给内存控制器，内存控制器再转换为具体的数据存储位置，从而让内存完成指定位置的读写操作。
   
# 多CPU如何访问同一块内存？

NUMA架构，每个CPU（NUMA节点）直接链接一部分内存，访问这块内存就是【本地访问】，然后如果需要的数据不在本地，就需要cpu间通信，称为【远程访问】。这种方式成为非一致性内存访问，因为在本地访问和远程访问的速度肯定不一样。

内存如何分配？有亲和性策略，线程在哪个NUMA节点上，就把它使用的内存直接分配到本地直连的内存上去。但这会造成一个线程如果过量使用内存，会发生频繁的内存页面交换到硬盘上去，而其他NUMA节点上的内存空闲没有被使用。因此，更新后的策略是内存均匀分配。

# 机械硬盘如何存储数据？

在之前的学习中，可以总结出内存通过电容存储数据，电容上的电压在一定范围内就是1，否则为0，而缓存通过晶体管导通来存储数据，导通为1，不通为0。每个存储单元可以表示1比特位的数据。

机械硬盘也称磁盘，是利用金属磁粒的极性来表示比特位，由多个磁粒组成一个单元格，表示一个比特位。单元格中的磁粒方向向上为1，向下为0。

读写数据的话，就需要磁头来操作，磁盘本身在旋转，磁头的尾端有写磁头和读磁头，读就是通过电磁技术检测下方单元格的磁性，判断是0还是1。写就是通过写磁头改变下方单元格的极性。

寻址：硬盘上的存储位置是统一编址的。硬盘读写的单位为扇区，一个扇区的容量是512字节。

硬盘驱动程序会完成计算数据所在盘面、磁道、扇区编号的任务。然后将磁头臂移动到对应磁道上方，这个动作叫做寻道，然后等待对应扇区旋转到磁头下方来读写数据。

如果一个扇区不能满足读写需求，需要占据多个扇区，就需要文件系统来解决了。

# 硬盘如何被计算机系统管理

假设1个文件中只有1个字符，1字符=1字节=4KB存储空间。原因如下：

机械硬盘的读写以扇区为单位，即使只是需要读到这1个字符，也需要把整个扇区一起读出来。

操作系统的读写以块为单位，这个块包含了多个连续扇区，要读就一起读出来。一般常见的都是8个扇区构成一个块，就是512*8=4096字节，也就是4KB。

所以1字符的文件占据4KB存储空间。也就是文件系统以4KB大小的块block来管理硬盘空间。

# 如何知道哪些块能用？哪些块已经被使用？







