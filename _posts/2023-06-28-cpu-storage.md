---
layout: default
title: 2023/06/28 CPU存储
author: sindweller <sindweller5530@gmail.com>
tags: [操作系统]
---

# 缓存与内存

缓存比内存快，是因为内存的存储是用的DRAM单元，动态随机存储器，需要电容充放电来实现数据存储，这是很慢的。

> 所谓动态，指的是需要周期性充电才能维持数据稳定，因为电容会“漏电”，电压变小之后就无法区分表达的是1还是0了。

缓存不需要充电，用的SRAM电路，是静态随机存储器，存储利用的是晶体管的导通与断开，速度很快。

这两个DRAM和SRAM单元都可以存储1比特的信息。但是缓存1单元要花费很多晶体管，而内存1单元只需要1个晶体管。

所以缓存也就是MB KB级别的，内存可以做到几十GB的容量。

# 内存如何存储数据

首先，内存存了什么数据？CPU工作需要指令、数据都存在内存里。

内存条里面有很多核心存储芯片，总共空间有16 * 1GB=16GB。连接内存和主板的插槽接触点被称为金手指。除此之外，还有PCB电路板。

存储芯片+PCB电路板+金手指=内存条。

内存条的另一个名称为RAM，随机存储器，因为可以随意读写上面任意位置的数据。寻找比特位需要告知内存芯片号、bank号、行地址、列地址。这些细节封装好了作为一个接口对外提供服务，由内存控制器完成。

内存控制器有两个主要的任务：

1. 定期刷新电容，最多64ms就要刷新一次
2. 寻址，用比特位作为读写单位太麻烦了，所以将比特位8个一组，分为1字节，CPU按照字节位单位统一给这些存储空间编址，将地址交给内存控制器，内存控制器再转换为具体的数据存储位置，从而让内存完成指定位置的读写操作。
   
# 多CPU如何访问同一块内存？

NUMA架构，每个CPU（NUMA节点）直接链接一部分内存，访问这块内存就是【本地访问】，然后如果需要的数据不在本地，就需要cpu间通信，称为【远程访问】。这种方式成为非一致性内存访问，因为在本地访问和远程访问的速度肯定不一样。

内存如何分配？有亲和性策略，线程在哪个NUMA节点上，就把它使用的内存直接分配到本地直连的内存上去。但这会造成一个线程如果过量使用内存，会发生频繁的内存页面交换到硬盘上去，而其他NUMA节点上的内存空闲没有被使用。因此，更新后的策略是内存均匀分配。

# 机械硬盘如何存储数据？

在之前的学习中，可以总结出内存通过电容存储数据，电容上的电压在一定范围内就是1，否则为0，而缓存通过晶体管导通来存储数据，导通为1，不通为0。每个存储单元可以表示1比特位的数据。

机械硬盘也称磁盘，是利用金属磁粒的极性来表示比特位，由多个磁粒组成一个单元格，表示一个比特位。单元格中的磁粒方向向上为1，向下为0。

读写数据的话，就需要磁头来操作，磁盘本身在旋转，磁头的尾端有写磁头和读磁头，读就是通过电磁技术检测下方单元格的磁性，判断是0还是1。写就是通过写磁头改变下方单元格的极性。

寻址：硬盘上的存储位置是统一编址的。硬盘读写的单位为扇区，一个扇区的容量是512字节。

硬盘驱动程序会完成计算数据所在盘面、磁道、扇区编号的任务。然后将磁头臂移动到对应磁道上方，这个动作叫做寻道，然后等待对应扇区旋转到磁头下方来读写数据。

如果一个扇区不能满足读写需求，需要占据多个扇区，就需要文件系统来解决了。

# 硬盘如何被计算机系统管理

假设1个文件中只有1个字符，1字符=1字节=4KB存储空间。原因如下：

机械硬盘的读写以扇区为单位，即使只是需要读到这1个字符，也需要把整个扇区一起读出来。

操作系统的读写以块为单位，这个块包含了多个连续扇区，要读就一起读出来。一般常见的都是8个扇区构成一个块，就是512*8=4096字节，也就是4KB。

所以1字符的文件占据4KB存储空间。也就是文件系统以4KB大小的块block来管理硬盘空间。
 
# 如何知道哪些块能用？哪些块已经被使用？

块位图：每个比特位记录存不存在，比如第三个位置是1，代表第三个数据块已经被使用了

为了能快速找到数据块的位置，使用一个inode对象保存这个4KB的块的信息，包括位置、权限、大小之类的。inode作为一个索引，找到inode就能快速找到数据块。

硬盘的示意图如下：

```shell
+--------------------------------------------------------------+
|                           文件系统                            |
+--------------------------------------------------------------+
|                            块位图                             |
+--------------------------------------------------------------+
|                            inode表                           |
+--------------------------------------------------------------+
|                             数据块                            |
+--------------------------------------------------------------+
```

当一个文件大小比较大，一个数据块放不下的时候，就是分散存储为多个数据块而不是连续的（连续的硬盘就变成消不掉的俄罗斯方块了，很容易出现空洞）。

因此，inode还要记录这个文件占用的所有数据块的编号，但inode的空间只有128字节，显然存储不了这么多信息，所以又加了一级间接索引来做辅助查询，inode对象只需要记录一个数据块的编号就好了，而这个数据块中记录的是文件所有数据块的编号。


## 目录

目录记录文件名和inode的映射关系。里面的item是目录像，记录属于这个目录下的所有文件，通过目录项来将文件名翻译为inode。

因此先找目录，再找文件。为了能够从头查找，根目录文件存放在inode的这个表格的起始位置。

小总结：
- 块位图用于记录哪些数据块可用，是一个专门用来记录的数据块，不存实际数据。
- inode位图能知道inode里哪些表项（item）可用，当然inode表也是一个数据块。
- inode表格（目录）能定位目录和文件。

## 实际使用情况

用一个数据块来记录inode表项还是太少了，因为4096/128=32，也就是说一个数据块最多只能存储32个inode对象，一个硬盘肯定不止32个文件。

那么就不能只用一个数据块来记录inode了。但是一旦有多个数据块，就又得建立一个目录/索引来记录这些inode数据块的位置。这个索引就是描述符。

并且，块位图由一个块承担，最多表示8*4096=32768个数据块，32758*4KB= 128MB，也有可能无法完全表示硬盘的空间。

因此将这些块分组，每个组里自己单独管理，成为块组，索引变成组描述符。

然后再用一个超级块来记录全局的信息，它放在第一个块组的最前面。

硬盘首先划分为多个分区，每个分区可以使用不同的文件系统。分区开头还有一个启动扇区DBR，在其最前还有一个引导块，在安装操作系统的时候引导程序就会被写进引导块里。

类似超级块，将分区的全局信息记录下来，存储到硬盘的第一个扇区上，成为主引导记录MBR。

分区内块组的结构：

```shell
+---------------------------------------------------------------+
|                             硬盘                                |
+---------------------------------------------------------------+
|                           超级块                                 |
+---------------------------------------------------------------+
|                         块组描述符                               |
+---------------------------------------------------------------+
|                          Inode 位图块                            |
+---------------------------------------------------------------+
|                          Inode 表                                |
+---------------------------------------------------------------+
|                          数据块                                   |
+---------------------------------------------------------------+
```

上述文件系统为ext2。

